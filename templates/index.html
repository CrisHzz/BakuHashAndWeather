<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakuHashAndWeather</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="flag-stripe blue"></div>
            <div class="flag-stripe red"></div>
            <div class="flag-stripe green"></div>
            <h1 class="title">
                <span class="baku-text">Baku</span>
                <span class="hash-text">Hash</span>
                <span class="and-text">And</span>
                <span class="baku-text">Weather <img src="https://vectorflags.s3.amazonaws.com/flags/az-flag-01.png" width="100"></span>
            </h1>
            <p class="subtitle">Predicci√≥n del Clima de Bak√∫ y cifrado de datos</p>
        </header>

        <main class="main-content">
            <div class="form-container">
                <div class="form-header">
                    <h2>Datos Hist√≥ricos del Clima</h2>
                    <p>Ingresa los datos de los √∫ltimos 3 d√≠as para generar la predicci√≥n</p>
                </div>

                <form class="weather-form" id="weatherForm">
                    <!-- D√≠a 1 -->
                    <div class="day-section">
                        <h3 class="day-title">
                            <span class="day-number">1</span>
                            Hace 3 d√≠as
                        </h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label for="day1-max">Temperatura M√°xima (¬∞C)</label>
                                <input type="number" id="day1-max" name="day1-max" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">üå°Ô∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day1-min">Temperatura M√≠nima (¬∞C)</label>
                                <input type="number" id="day1-min" name="day1-min" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">‚ùÑÔ∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day1-sun">Horas de Sol</label>
                                <input type="number" id="day1-sun" name="day1-sun" min="0" max="24" step="0.1" required>
                                <span class="input-icon">‚òÄÔ∏è</span>
                            </div>
                        </div>
                    </div>

                    <!-- D√≠a 2 -->
                    <div class="day-section">
                        <h3 class="day-title">
                            <span class="day-number">2</span>
                            Hace 2 d√≠as
                        </h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label for="day2-max">Temperatura M√°xima (¬∞C)</label>
                                <input type="number" id="day2-max" name="day2-max" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">üå°Ô∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day2-min">Temperatura M√≠nima (¬∞C)</label>
                                <input type="number" id="day2-min" name="day2-min" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">‚ùÑÔ∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day2-sun">Horas de Sol</label>
                                <input type="number" id="day2-sun" name="day2-sun" min="0" max="24" step="0.1" required>
                                <span class="input-icon">‚òÄÔ∏è</span>
                            </div>
                        </div>
                    </div>

                    <!-- D√≠a 3 -->
                    <div class="day-section">
                        <h3 class="day-title">
                            <span class="day-number">3</span>
                            Ayer
                        </h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label for="day3-max">Temperatura M√°xima (¬∞C)</label>
                                <input type="number" id="day3-max" name="day3-max" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">üå°Ô∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day3-min">Temperatura M√≠nima (¬∞C)</label>
                                <input type="number" id="day3-min" name="day3-min" min="-20" max="50" step="0.1" required>
                                <span class="input-icon">‚ùÑÔ∏è</span>
                            </div>
                            <div class="input-field">
                                <label for="day3-sun">Horas de Sol</label>
                                <input type="number" id="day3-sun" name="day3-sun" min="0" max="24" step="0.1" required>
                                <span class="input-icon">‚òÄÔ∏è</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="predict-btn">
                            <span>üîÆ</span>
                            Generar Predicci√≥n
                        </button>
                        <button type="reset" class="reset-btn">
                            <span>üîÑ</span>
                            Limpiar Datos
                        </button>
                    </div>
                </form>
            </div>

            <!-- Secci√≥n de Hasheo -->
            <div class="form-container hash-section">
                <div class="form-header">
                    <h2>üîê Encriptaci√≥n y Hasheo</h2>
                    <p>Ingresa un JSON para generar su hash criptogr√°fico</p>
                </div>

                <form class="hash-form" id="hashForm">
                    <div class="hash-input-section">
                        <div class="input-field">
                            <label for="jsonInput">JSON a Hashear</label>
                            <textarea 
                                id="jsonInput" 
                                name="jsonInput" 
                                placeholder='{"ejemplo": "Tu JSON aqu√≠... (m√°ximo 120 caracteres)"}'
                                rows="8"
                                required></textarea>
                            <span class="input-icon">üìÑ</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="hash-btn">
                            <span>üîê</span>
                            Cifrar JSON
                        </button>
                        
                        <button type="button" class="decrypt-btn" id="decryptBtn" style="display: none;">
                            <span>üîì</span>
                            Descifrar
                        </button>
                        
                        <button type="reset" class="reset-btn">
                            <span>üîÑ</span>
                            Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <footer class="footer">
            <div class="cultural-elements">
                <span class="element">üèõÔ∏è Patrimonio de Bak√∫</span>
                <span class="element">üî• Torres de la Llama</span>
                <span class="element">üåä Mar Caspio</span>
            </div>
            <p>&copy; 2024 BakuHashAndWeather - Predicci√≥n del Clima de Azerbaiy√°n</p>
        </footer>
    </div>

    <!-- Modal para mostrar resultados -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="resultContent">
                <!-- Los resultados se mostrar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        document.getElementById('weatherForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Obtener todos los datos del formulario
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Mostrar indicador de carga
            const submitBtn = document.querySelector('.predict-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>‚è≥</span> Generando Predicci√≥n...';
            submitBtn.disabled = true;
            
            try {
                // Enviar datos al servidor
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult(result);
                } else {
                    showError(result.error || 'Error en la predicci√≥n');
                }
                
            } catch (error) {
                showError('Error de conexi√≥n: ' + error.message);
            } finally {
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        function showResult(result) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            
            // Generar explicaci√≥n bas√°ndose en la temperatura predicha
            const explanation = generateExplanation(result.temp, result.weather);
            
            content.innerHTML = `
                <div class="result-header">
                    <h2>üîÆ Predicci√≥n del Clima</h2>
                    <p>Bak√∫, Azerbaiy√°n</p>
                </div>
                <div class="prediction-card">
                    <div class="temp-display">
                        <span class="temp-number">${result.temp}¬∞C</span>
                        <span class="temp-label">Temperatura M√°xima Predicha</span>
                    </div>
                    <div class="weather-info">
                        <div class="weather-type">
                            <span class="weather-icon">${getWeatherIcon(result.weather)}</span>
                            <span class="weather-text">${result.weather}</span>
                        </div>
                        <div class="explanation">
                            <p>${explanation}</p>
                        </div>
                    </div>
                </div>
                <button onclick="closeModal()" class="close-btn">
                    <span>‚úÖ</span> Entendido
                </button>
                <div class="json-section">
                    <h3>üìã JSON de Respuesta</h3>
                    <div class="json-container">
                        <pre id="jsonOutput">${JSON.stringify(result, null, 2)}</pre>
                        <button onclick="copyToClipboard()" class="copy-btn">
                            <span>üìã</span> Copiar JSON
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function showError(message) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            
            content.innerHTML = `
                <div class="error-content">
                    <h2>‚ùå Error</h2>
                    <p>${message}</p>
                    <button onclick="closeModal()" class="close-btn error">
                        <span>üîÑ</span> Intentar Nuevamente
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function getWeatherIcon(weather) {
            switch(weather.toLowerCase()) {
                case 'caluroso': return 'üåû';
                case 'templado': return 'üå§Ô∏è';
                case 'fresco': return 'üå•Ô∏è';
                case 'fr√≠o': return '‚ùÑÔ∏è';
                case 'muy fr√≠o': return 'ü•∂';
                case 'helado': return 'üßä';
                default: return 'üå§Ô∏è';
            }
        }
        
        function generateExplanation(temperature, weather) {
            if (temperature >= 30) {
                return "Se espera un d√≠a muy caluroso, se recomienda mantenerse hidratado y evitar exposici√≥n prolongada al sol";
            } else if (temperature >= 20) {
                return "Se espera un d√≠a agradable con temperatura moderada";
            } else if (temperature >= 15) {
                return "Se espera un d√≠a fresco, se recomienda llevar ropa ligera";
            } else if (temperature >= 10) {
                return "Se espera un d√≠a fr√≠o, se recomienda abrigarse bien";
            } else if (temperature >= 5) {
                return "Se espera un d√≠a muy fr√≠o, se recomienda abrigarse muy bien y evitar exposici√≥n prolongada";
            } else {
                return "Se espera un d√≠a helado, se recomienda extremar precauciones y evitar salir si es posible";
            }
        }
        
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }
        
        function copyToClipboard() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(jsonText).then(function() {
                // Cambiar el texto del bot√≥n temporalmente
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>‚úÖ</span> ¬°Copiado!';
                btn.style.background = 'linear-gradient(45deg, #00AA00, #00CC33)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(function(err) {
                console.error('Error al copiar: ', err);
                alert('Error al copiar al portapapeles');
            });
        }
        
        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('resultModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Cerrar modal con la X
        document.querySelector('.close').onclick = function() {
            closeModal();
        }

        // Variables globales para almacenar datos de cifrado
        let encryptedData = null;

        // Manejar formulario de hash/cifrado
        document.getElementById('hashForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const jsonInput = formData.get('jsonInput');
            
            // Validar que el JSON sea v√°lido y no sea demasiado largo
            try {
                JSON.parse(jsonInput);
            } catch (error) {
                showHashError('El texto ingresado no es un JSON v√°lido');
                return;
            }
            
            // Validar tama√±o del JSON
            if (jsonInput.length > 120) {
                showHashError(`El JSON es demasiado largo (${jsonInput.length} caracteres). M√°ximo permitido: 120 caracteres.`);
                return;
            }
            
            // Mostrar indicador de carga
            const submitBtn = document.querySelector('.hash-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>‚è≥</span> Cifrando...';
            submitBtn.disabled = true;
            
            try {
                // Agregar timeout de 30 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch('/encrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ jsonInput: jsonInput }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Verificar que la respuesta sea v√°lida antes de procesarla
                const responseText = await response.text();
                let result;
                
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Error parsing JSON:', parseError);
                    console.error('Response text:', responseText);
                    showHashError(`Error de formato en la respuesta del servidor: ${parseError.message}`);
                    return;
                }
                
                if (response.ok) {
                    encryptedData = result;
                    showHashResult(result, 'encrypt');
                    // Mostrar bot√≥n de descifrado
                    document.getElementById('decryptBtn').style.display = 'inline-block';
                } else {
                    showHashError(result.error || 'Error en el cifrado');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showHashError('Timeout: El proceso de cifrado est√° tomando demasiado tiempo. Intenta con un JSON m√°s peque√±o (m√°ximo 120 caracteres).');
                } else {
                    showHashError('Error de conexi√≥n: ' + error.message);
                }
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Manejar bot√≥n de descifrado
        document.getElementById('decryptBtn').addEventListener('click', async function() {
            if (!encryptedData) {
                showHashError('No hay datos cifrados para descifrar');
                return;
            }
            
            const submitBtn = this;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>‚è≥</span> Descifrando...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/decrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        coefficients: encryptedData.encrypted_coefficients,
                        x_data: encryptedData.x_data,
                        y_data: encryptedData.y_data  // Incluir datos originales para descifrado estable
                    })
                });
                
                // Verificar que la respuesta sea v√°lida antes de procesarla
                const responseText = await response.text();
                let result;
                
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Error parsing JSON en decrypt:', parseError);
                    console.error('Response text:', responseText);
                    showHashError(`Error de formato en la respuesta del servidor: ${parseError.message}`);
                    return;
                }
                
                if (response.ok) {
                    showHashResult(result, 'decrypt');
                } else {
                    showHashError(result.error || 'Error en el descifrado');
                }
                
            } catch (error) {
                showHashError('Error de conexi√≥n: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        function showHashResult(result, type) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            
            let htmlContent = '';
            
            if (type === 'encrypt') {
                htmlContent = `
                    <div class="result-header">
                        <h2>üîê Cifrado Completado</h2>
                        <p>Tu JSON ha sido cifrado exitosamente</p>
                    </div>
                    <div class="hash-result-card">
                        <div class="original-section">
                            <h3>üìÑ JSON Original</h3>
                            <div class="json-container">
                                <pre>${JSON.stringify(JSON.parse(result.original_message), null, 2)}</pre>
                            </div>
                        </div>
                        <div class="encrypted-section">
                            <h3>üîê Coeficientes Cifrados</h3>
                            <div class="coefficients-container">
                                <pre>${JSON.stringify(result.encrypted_coefficients, null, 2)}</pre>
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>üìä Informaci√≥n del Cifrado</h3>
                            <p><strong>Puntos de interpolaci√≥n:</strong> ${JSON.stringify(result.x_data)}</p>
                            <p><strong>N√∫mero de coeficientes:</strong> ${result.encrypted_coefficients.length}</p>
                            <p><strong>Estado:</strong> ${result.message}</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="close-btn">
                        <span>‚úÖ</span> Entendido
                    </button>
                `;
            } else if (type === 'decrypt') {
                htmlContent = `
                    <div class="result-header">
                        <h2>üîì Descifrado Completado</h2>
                        <p>El mensaje ha sido descifrado exitosamente</p>
                    </div>
                    <div class="hash-result-card">
                        <div class="decrypted-section">
                            <h3>üìÑ JSON Descifrado</h3>
                            <div class="json-container">
                                <pre>${JSON.stringify(JSON.parse(result.decrypted_message), null, 2)}</pre>
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>‚úÖ Resultado</h3>
                            <p><strong>Estado:</strong> ${result.message}</p>
                            <p><strong>Integridad:</strong> Mensaje recuperado correctamente</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="close-btn">
                        <span>‚úÖ</span> Entendido
                    </button>
                    <div class="json-section">
                        <div class="json-container">
                            <button onclick="copyHashToClipboard()" class="copy-btn">
                                <span>üìã</span> Copiar JSON Descifrado
                            </button>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = htmlContent;
            modal.style.display = 'block';
        }
        
        function showHashError(message) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            
            content.innerHTML = `
                <div class="error-content">
                    <h2>‚ùå Error de Cifrado</h2>
                    <p>${message}</p>
                    <button onclick="closeModal()" class="close-btn error">
                        <span>üîÑ</span> Intentar Nuevamente
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function copyHashToClipboard() {
            const jsonText = document.querySelector('.decrypted-section pre').textContent;
            navigator.clipboard.writeText(jsonText).then(function() {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>‚úÖ</span> ¬°Copiado!';
                btn.style.background = 'linear-gradient(45deg, #00AA00, #00CC33)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(function(err) {
                console.error('Error al copiar: ', err);
                alert('Error al copiar al portapapeles');
            });
        }

        // Limpiar datos de cifrado al resetear el formulario
        document.querySelector('.hash-form .reset-btn').addEventListener('click', function() {
            encryptedData = null;
            document.getElementById('decryptBtn').style.display = 'none';
        });
    </script>
</body>
</html>